# Data In Data: 聚合网络费用还是超额燃烧

TL;DR

## 梗概

Filecoin 网络的 `Chocolate` 升级在 1231620 高度 (北京时间 2021年10月26日 21时30分) 准时上线。本次升级对于封装算力的成本有着显著的影响。

从7日趋势线上，我们看到 BaseFee 从升级前的长期低于 0.1nanoFIL 甚至低于 0.05nanoFIL 的水平，短时间内攀升到在 0.3nanoFIL 上下波动的水平。

根据协议实验室官方给出的测算，在新的参数条件下，ProveCommit 聚合与非聚合的成本平衡线大约在 0.32nanoFIL。



## 初步猜想

那么实际运行情况如何？从一系列分析中，我们发现 `ProveCommitSector` 消息的提交情况似乎存在一些有趣的现象：

在升级高度 +1d ~ +2d 这样一个时间区间内：

1. 提交消息且执行成功(ExitCode = Ok)数量超过1000条的，共有 136 个存储供应商

2. 所涉及的供应商中， 有 61 个存在同时段内提交过被打包但执行过程中由于 Gas 限量不足(ExitCode = SysErrOutOfGas) 而失败的消息的情况

3. 提交的成功消息数量排名前十的存储供应商中：

   只有一家的 OutOfGas 消息数占比 为 0.13%， 一家为 0.95%，其余八家均超过 2.2%，最多达到9.7%；

   涉及的 GasFee 损失占比最高达到 8.9%，绝对值最高达到 24.5 FIL

为什么这些增速不低的存储供应商有相当一部分都面临着比例不低 的 OutOfGas 占比，并承担着这种情况带来的额外成本呢？原因大致有两个：

- 相比其他类型的消息，`ProveCommitSector` 的 Gas 消耗浮动的范围比较大。

  根据经验，同一个矿工，在同一个高度上链的消息，其Gas消耗总体呈现出锯齿状，最高值和最低值之间相差超过20%；

  这种情况主要受链数据存储结构的总体量和变化量影响，对应到宏观层面即此供应商的算力总量和算力增速；

- 被广泛使用的 Filecoin 实现 `lotus` 中，对消息的 Gas 估算是静态的、单点的，不能很好地体现其他消息对本条消息的影响，

  因而增速较快的供应商在使用这套方案时，很容易在大量消息并发地进行估算时得到偏差较大的结果。



那么，如果要对消息上链的成本进行管控，比较容易想到的选择有两种：

1. 在 BaseFee 到达 0.32 nanoFIL 之前就开启聚合，通过聚合消息Gas 消耗值相对平稳，容易预估准确的特点来规避 OutOfGas 消息的出现；
2. 通过提升消息 Gas 估算时的乘倍系数，即放大 GasLimit 来减少 OutOfGas 消息的出现

这两种做法都会带来额外的成本，前者显而易见是聚合网络费用，而后者则是隐性的超额燃烧费用。

那么这两者的成本表现究竟如何？我们将尝试分析。



## 精确分析

### 数据准备

#### 单个提交的 Gas 情况

我们首先进行 Gas 层面的数据提取。

选取成功消息数量排名前20的 存储供应商

`f01208627, f01111881, f0440919, f070932, f01321901, f01190147, f01171513, f030347, f01264319, f01246563, f01215282, f01114802, f01209185, f01348517, f01368089, f01114589, f090911, f062937, f0145060, f01174977`

提取其同一时段内，执行成功的 `ProveCommitSector` 消息 的 Gas 表现如下:

| Miner   | GasUsedAvg  | GasUsedMin | GasUsedMax | GasLimitAvg | GasLimitMin | GasLimitMax | AvgOverRatio | MinOverRatio | MaxOverRatio |
| ------- | ----------- | ---------- | ---------- | ----------- | ----------- | ----------- | ------------ | ------------ | ------------ |
| 1246563 | 52482337.9  | 43014717   | 92449505   | 67704535.04 | 53692021    | 109752456   | 1.290044     | 1.248224     | 1.187161     |
| 1208627 | 66291089.62 | 43129334   | 92734422   | 81889872.07 | 53692021    | 109752456   | 1.235307     | 1.244907     | 1.183514     |
| 1111881 | 57978580.78 | 43014717   | 92192105   | 77153645.22 | 53692021    | 109752456   | 1.330727     | 1.248224     | 1.190476     |
| 30347   | 65787562.81 | 43308734   | 92228505   | 82284751.88 | 53797646    | 109806081   | 1.250765     | 1.242189     | 1.190587     |
| 1264319 | 56887126.34 | 43010817   | 92600305   | 75141392.53 | 53687146    | 109747581   | 1.320886     | 1.248224     | 1.185175     |
| 1114802 | 51922602.58 | 43013417   | 72434625   | 63100669.34 | 53757021    | 84961356    | 1.215283     | 1.249773     | 1.172938     |
| 1321901 | 59687015.71 | 43014717   | 92313005   | 77471761.94 | 53692021    | 109752456   | 1.297967     | 1.248224     | 1.188917     |
| 1114589 | 54123517    | 43010817   | 72196725   | 66114567.39 | 53761896    | 84959731    | 1.22155      | 1.249962     | 1.176781     |
| 70932   | 59079625.48 | 42975517   | 92414422   | 82766899.66 | 57934462    | 118479732   | 1.400938     | 1.348081     | 1.282048     |
| 1171513 | 63817482.51 | 43010817   | 92168922   | 79847894.46 | 53687146    | 109747581   | 1.251192     | 1.248224     | 1.190722     |
| 440919  | 66210298.55 | 43012117   | 92380822   | 81207948.73 | 53688771    | 109749206   | 1.226515     | 1.248224     | 1.188009     |
| 145060  | 66295908.08 | 42972917   | 92462305   | 81220912.72 | 53639771    | 109556935   | 1.225127     | 1.248223     | 1.184882     |
| 1215282 | 50879652.64 | 43004317   | 85927325   | 63616768.93 | 53679021    | 101705085   | 1.250338     | 1.248224     | 1.183617     |
| 90911   | 52365207.49 | 43014717   | 87026868   | 65714646.4  | 53692021    | 109609185   | 1.25493      | 1.248224     | 1.259487     |
| 1174977 | 59166069.59 | 43010817   | 91656248   | 73764668.96 | 53687146    | 109747581   | 1.246739     | 1.248224     | 1.197382     |
| 1348517 | 50680242.8  | 43012117   | 91188248   | 64364200.7  | 53688771    | 109605935   | 1.270006     | 1.248224     | 1.201974     |
| 62937   | 49388297.78 | 43008217   | 82276668   | 66813708.76 | 53682271    | 109547435   | 1.352825     | 1.248186     | 1.331452     |
| 1209185 | 66400431.05 | 43194334   | 92264905   | 81757347.19 | 53692021    | 109752456   | 1.231277     | 1.243034     | 1.189536     |
| 1368089 | 51169849.81 | 43006917   | 91816405   | 65196748.69 | 53539000    | 109547435   | 1.274124     | 1.244893     | 1.193114     |
| 1190147 | 64595065.09 | 43012117   | 92669205   | 79332754.92 | 53688771    | 109749206   | 1.228155     | 1.248224     | 1.184312     |

注：之所以在平均值的超额倍数(AvgOverRatio) 之外又计算了最大值最小值各自的超额倍数，是因为这两者通常成对出现

总体上来说，我们大致可以断定这20家土豪基本都是使用了 `lotus` 的标准乘数配置 `1.25`。



#### 聚合提交的 Gas 参照

这 20 家供应商 24 小时的消息提交量最低为 6345，那么可以保证平均每小时至少聚合 260 条 `ProveCommit`。

我们知道，正常情况下，聚合的扇区越多，平均的 Gas 消耗越低。因此我们必须保证选取的消息聚合数量与 260 这个数字接近。

很遗憾，同时段内 260~270 这样一个聚合档位的数量为0，因此我们扩大到 200 ~ 280，得出的结果如下：

| Miner   | Msg  | Sector | Gas         | AvgGas    |
| ------- | ---- | ------ | ----------- | --------- |
| 1198583 | 23   | 4600   | 12816180432 | 2786126.2 |
| 1079999 | 16   | 3200   | 8718813848  | 2724629.3 |
| 1130671 | 31   | 6200   | 23023365702 | 3713446.1 |
| 30347   | 4    | 1024   | 3415239519  | 3335194.8 |
| 1262966 | 91   | 23296  | 1.07874E+11 | 4630573.9 |
| 1114589 | 1    | 239    | 1076821663  | 4505530   |
| 1208627 | 3    | 600    | 2873197773  | 4788663   |
| 1111831 | 7    | 1400   | 3273608319  | 2338291.7 |
| 1077708 | 1    | 223    | 562031711   | 2520321.6 |



### 公式分析

#### 超额燃烧成本核算

对于超额燃烧，根据其计算公式，我们可以得出：

假设每次估算基本准确，令可配置项 OverEstimationRatio 为 O，每消息超额燃烧折算的 Gas 比例为 G，那么
$$
G = \left\{
		\begin{aligned}
			0&, O\leq1.1 \\
			(O-1.1)\times(O-1)&, 1.1 < O \leq 2.1 \\
			O-1&, O > 2.1
		\end{aligned}
	\right.
$$
也就是说，考虑超额燃烧费的情况下， 名义上的 Gas值将为： `GasUsed' = GasUsed * (1+G)`



以单条消息消耗 52000000 Gas 为例，在设置 O 为 1.25时，名义上的 Gas:

$ Gas = 52000000 \times (1 + (1.25 - 1.1) \times (1.25-1)) = 52000000 \times 1.0375 = 53950000$

再考虑到实际的成本消耗中还有一小部分是打包小费等，我们可以视之为一个较小的常量 `c`

那么最终的消息成本公式为
$$
TotalCost = BaseFee \times GasUsed \times (1+G+c)
$$
从结果上来说，这个公式和我们之前的经验中， 在 O 设置为 1.25 时产生约 3% 的超额燃烧成本是能相互印证的。



#### 聚合网络费成本核算

首先，根据 `specs-actors v6` 的参数设置，对于 `ProveCommit` 的聚合网络费用为:

$0.25nanoFIL \times 49299973$

为了方便，我们可以理解为， 在 BaseFee 为 0.25nanoFIL 时，相当于给每个扇区多支付 49299973 Gas 对应的代币成本。

那么，我们可以粗略认为：

在同样0.25nanoFIL 的 BaseFee 水平下，按照约 250 个扇区一次进行聚合提交，采集的 Gas 均值情况，我们可以得出 单个扇区的 Gas 将处于 `49299973 + 2520321.6` ~ `49299973  + 4788663` 这样一个区间，具体为 `51820294.6` ~ `54088636` 。



### 简单结论



通过上两个小节的分析，结合我们从链上采集的数据来看，如果要简单粗暴地进行总结，那就是：

对于单个Prove提交使用量排名前 20 的大佬们来说， 只要 BaseFee 超过 0.25，就可以无脑一把梭，转向聚合的怀抱。

因为除了其中平均 Gas 表现最好的 `f062937`，凭借折算出的每扇区实际 Gas 消耗下限值 `49388297.78 * 1.0375 = 51240358.94675`，和 0.05% 的超低 OutOfGas 成本损失还能稍微挣扎一下以外，其余土豪在这个增速量级上都很难翻转面对聚合条件下 `51820294.6` ~ `54088636` 的 Gas 成本表现。



### 扩展结论



那么，如果 BaseFee 相较 0.25 nanoFIL，维持在一个更低的水平线上，情况又会怎样呢？

首先进行公式化对决，有请聚合选手
$$
\frac{0.25nanoFIL}{BaseFee} \times 49299973 + AvgGasUsed_{batch} \times (1 + G + c)
$$
接下来是光棍选手：
$$
AvgGasUsed_{single} \times (1+G+c)
$$
如果将 0.20 带入聚合公式，我们将看到原本的 49299973 变成了 61624966.25 这样似乎有 13 位土豪看到了转机。

接下来，假设这些土豪通过放大 O 的方式来提示成功率，那么有什么样的可能性？

首先计算放大 O 带来的成本变化， 以原值为 1.25，可以看到

| O    | 额外成本                    |
| ---- | --------------------------- |
| 1.3  | 0.2 * 0.3 - 0.0375 = 0.0225 |
| 1.4  | 0.3 * 0.4 - 0.0375 = 0.0825 |
| 1.5  | 0.4 * 0.5 - 0.0375 = 0.1625 |
| 1.6  | 0.5 * 0.6 - 0.0375 = 0.2625 |
| 1.7  | 0.6 * 0.7 - 0.0375 = 0.3825 |
| 1.8  | 0.8 * 0.9 - 0.0375 = 0.6825 |

可以看出来，在 1.4 的时候，靠增加超额燃烧弥补 OutOfGas 的计划就已经基本宣告无望，因为此时带来的额外成本已经和硬吃失败消息的最大损失相差不多了。

那么此时剩下的疑问就是，在不同的 BaseFee 水平线上，什么样的平均 Gas 表现可以给自己继续使用单个提交争取一点呼吸权？

取~250条聚合时的中位数表现值 `3335194.8`，对应结果如下：

| BaseFee | AvgGasUsed_Single                                            |
| ------- | ------------------------------------------------------------ |
| 0.20    | 49299973 * 0.25 / 0.20 + 3335194.8 * 1.0375 = 65085230.855   |
| 0.15    | 49299973 * 0.25 / 0.25 + 3335194.8 * 1.0375 = 85626886.2716667 |
| 0.10    | 49299973 * 0.25 / 0.10 + 3335194.8 * 1.0375 = 126710197.105  |
| 0.05    | 49299973 * 0.25 / 0.05 + 3335194.8 * 1.0375 = 249960129.605  |



## 最终结论

经过上面的一系列分析，我们最终得出一个什么样方便的结论呢？

首先，必须得说，在 BaseFee 处于动态变化，上链高度无法精确控制的情况下，上述分析的边界情形都有可能出现偏差，但大致的 Gas 级别不会偏差太大。

于是对于日产 6400 以上扇区（对应 32GiB 为 200TiB, 对应 64GiB 为 400TiB）的存储供应商来说，考虑失败消息和自身Gas管控水平

- 在 BaseFee 高于 0.25 nanoFIL 水平时，几乎全部应该转向聚合
- 在 BaseFee 低于 0.15 nanoFIL 水平时，几乎没有人需要采用聚合
- 在 BaseFee 处于 0.20 nanoFIL 水平时，如果图方便，大多数 Gas 控制水平没有达到极致的矿工可以选择无脑聚合



**如果想要在 Gas 控制水平和规避 OutOfGas 这两方面向极致发起挑战的存储供应商们，可以考虑联系 venus 团队了解 venus-message 项目。**

**如果对各种种类的链观测数据感兴趣的朋友，可以联系 ipfs-force-community 团队**





## 附录

### 附录 A： 24小时内提交成功的 ProveCommitSector 消息数量超过 4000 个存储供应商的OutOfGas 表现

| Miner   | MsgOk | MsgOutOfGas | GasOk       | GasOutOfGas | CostOk      | CostOutOfGas | MsgRatio   |
| ------- | ----- | ----------- | ----------- | ----------- | ----------- | ------------ | ---------- |
| 1208627 | 22456 | 1863        | 1.48863E+12 | 1.20267E+11 | 330.3656092 | 24.54562684  | 0.07660677 |
| 1111881 | 17552 | 408         | 1.01764E+12 | 26374777956 | 246.2593326 | 5.739600462  | 0.02271715 |
| 440919  | 14479 | 1022        | 9.58659E+11 | 65512278342 | 211.9185462 | 13.31038511  | 0.06593123 |
| 70932   | 14020 | 134         | 8.28296E+11 | 8865787502  | 200.6259996 | 1.830795916  | 0.00946729 |
| 1321901 | 13526 | 506         | 8.07327E+11 | 33331796333 | 187.7772791 | 7.010004831  | 0.03606043 |
| 1190147 | 13034 | 598         | 8.41932E+11 | 39580023292 | 179.5642364 | 7.996143542  | 0.04386737 |
| 1171513 | 11576 | 327         | 7.38751E+11 | 21685992241 | 158.9646002 | 4.645626745  | 0.02747207 |
| 30347   | 10519 | 1132        | 6.92019E+11 | 73031423021 | 153.8527067 | 15.04647061  | 0.09715904 |
| 1264319 | 9703  | 410         | 5.51976E+11 | 26039011829 | 123.6059834 | 4.403356982  | 0.04054188 |
| 1246563 | 9236  | 12          | 4.84727E+11 | 749705842   | 110.8208452 | 0.173496105  | 0.00129758 |
| 1215282 | 8083  | 2           | 4.1126E+11  | 125215170   | 91.22107278 | 0.013958293  | 0.00024737 |
| 1114802 | 7787  | 43          | 4.04321E+11 | 2342739457  | 88.8542049  | 0.424459373  | 0.0054917  |
| 1209185 | 7270  | 331         | 4.82731E+11 | 21364576215 | 103.9344965 | 4.372118029  | 0.0435469  |
| 1348517 | 7110  | 7           | 3.60337E+11 | 426005129   | 80.69447677 | 0.077649209  | 0.00098356 |
| 1368089 | 6908  | 8           | 3.53481E+11 | 468236515   | 79.91243615 | 0.09026553   | 0.00115674 |
| 1114589 | 6593  | 194         | 3.56836E+11 | 10862887775 | 82.85636263 | 2.266888572  | 0.02858406 |
| 90911   | 6538  | 5           | 3.42364E+11 | 304206861   | 73.33520729 | 0.054873967  | 0.00076418 |
| 62937   | 6477  | 3           | 3.19888E+11 | 173574583   | 74.57160993 | 0.040161484  | 0.00046296 |
| 145060  | 6407  | 325         | 4.24758E+11 | 20439856704 | 91.87735679 | 4.125619139  | 0.04827689 |
| 1174977 | 6345  | 26          | 3.75409E+11 | 1596212035  | 83.64036548 | 0.34825202   | 0.00408099 |
| 1273431 | 6151  | 0           | 3.11349E+11 |             | 69.39724349 |              | 0          |
| 392813  | 6147  | 7           | 3.16207E+11 | 464905021   | 71.78004392 | 0.11846838   | 0.00113747 |
| 1337799 | 5556  | 0           | 2.736E+11   |             | 59.82905452 |              | 0          |
| 1340093 | 5548  | 10          | 2.8924E+11  | 657456185   | 63.61076082 | 0.098092305  | 0.00179921 |
| 1264125 | 5246  | 1           | 2.56894E+11 | 53781417    | 56.4559387  | 0.009701285  | 0.00019059 |
| 469055  | 5077  | 9           | 2.62502E+11 | 530247436   | 58.8884839  | 0.10758362   | 0.00176956 |
| 377277  | 5049  | 91          | 3.05703E+11 | 5671356278  | 58.63872599 | 1.01622934   | 0.01770428 |
| 1330977 | 4974  | 5           | 2.45379E+11 | 294762884   | 59.11829886 | 0.065154286  | 0.00100422 |
| 1315096 | 4960  | 288         | 3.18505E+11 | 18211809414 | 74.44118259 | 3.825990933  | 0.05487805 |
| 1034007 | 4954  | 38          | 2.48527E+11 | 2522243156  | 55.55416163 | 0.507848525  | 0.00761218 |
| 1174867 | 4945  | 0           | 2.40198E+11 |             | 54.74797181 |              | 0          |
| 1177077 | 4809  | 0           | 2.33528E+11 |             | 51.44457437 |              | 0          |
| 1227383 | 4782  | 0           | 2.34243E+11 |             | 50.0949861  |              | 0          |
| 1032903 | 4718  | 2           | 2.29759E+11 | 111350127   | 50.48273898 | 0.01912805   | 0.00042373 |
| 1361111 | 4363  | 0           | 2.17853E+11 |             | 48.9452113  |              | 0          |
| 1022733 | 4239  | 7           | 2.15496E+11 | 431589592   | 56.32135153 | 0.13746007   | 0.00164861 |
| 867300  | 4191  | 3           | 2.05088E+11 | 174763593   | 46.55586805 | 0.03007286   | 0.00071531 |
| 1287    | 4076  | 181         | 2.69167E+11 | 11891401479 | 57.35249979 | 2.405014314  | 0.04251821 |
| 1035021 | 4039  | 5           | 2.46252E+11 | 260357103   | 40.58275568 | 0.033544594  | 0.0012364  |

### 附录 B: 不同聚合数量下的 Gas 表现

为方便进行不同体量下的分析，将更多档位的聚合 Gas 表现汇总表收录如下：



#### 50 - 100

| Miner   | Msg  | Sector | Gas      | AvgGas    |
| ------- | ---- | ------ | -------- | --------- |
| 844849  | 17   | 850    | 5.19E+09 | 6110092.8 |
| 1114577 | 19   | 1140   | 6.74E+09 | 5909161.8 |
| 1384139 | 138  | 8050   | 5.38E+10 | 6686832.7 |
| 1255369 | 11   | 704    | 3.26E+09 | 4633257.8 |
| 506630  | 1    | 52     | 2.68E+08 | 5144385.4 |
| 1384193 | 3    | 180    | 1.25E+09 | 6918087.8 |
| 1279006 | 1    | 64     | 3.35E+08 | 5228333.4 |
| 1372912 | 504  | 32256  | 2.38E+11 | 7386469.6 |
| 443480  | 2    | 100    | 4.73E+08 | 4733534.3 |
| 1287    | 4    | 200    | 1.27E+09 | 6354883.6 |
| 144528  | 1    | 86     | 3.35E+08 | 3889657.9 |
| 1372732 | 2    | 100    | 5.29E+08 | 5287300.9 |
| 1304462 | 1    | 70     | 3.46E+08 | 4937295.3 |
| 1225783 | 12   | 624    | 4.26E+09 | 6824224.7 |
| 65877   | 4    | 329    | 1.67E+09 | 5077493.3 |
| 443179  | 2    | 102    | 4.73E+08 | 4634227.9 |
| 1209185 | 5    | 400    | 2.59E+09 | 6479618.6 |
| 1045078 | 1    | 72     | 2.74E+08 | 3812013.2 |
| 1088088 | 10   | 500    | 2.53E+09 | 5068986.8 |
| 22820   | 26   | 1664   | 1.28E+10 | 7699289.6 |
| 17242   | 9    | 731    | 4.52E+09 | 6188282.7 |



#### 100 - 150

| Miner   | Msg  | Sector | Gas         | AvgGas    |
| ------- | ---- | ------ | ----------- | --------- |
| 1245980 | 167  | 16700  | 86822896989 | 5198975.9 |
| 24894   | 16   | 2080   | 8220655271  | 3952238.1 |
| 144528  | 1    | 149    | 469005519   | 3147688   |
| 440919  | 6    | 600    | 3565746725  | 5942911.2 |
| 1072221 | 1    | 120    | 528756995   | 4406308.3 |
| 1264319 | 1    | 100    | 368075566   | 3680755.7 |
| 1075159 | 24   | 3120   | 13459748645 | 4314022   |
| 1315096 | 1    | 128    | 452750713   | 3537114.9 |
| 592088  | 12   | 1200   | 4154942102  | 3462451.8 |
| 1137150 | 1    | 130    | 727844936   | 5598807.2 |
| 816168  | 4    | 400    | 2108268574  | 5270671.4 |
| 49911   | 185  | 18500  | 1.32E+11    | 7160432.4 |
| 1250837 | 21   | 2100   | 8496973039  | 4046177.6 |
| 132618  | 1    | 128    | 364422724   | 2847052.5 |
| 24563   | 85   | 8500   | 35899533273 | 4223474.5 |
| 1022733 | 34   | 4420   | 19695943644 | 4456095.8 |
| 1223505 | 4    | 408    | 1405005600  | 3443641.2 |
| 1392069 | 1    | 128    | 463074684   | 3617771   |



#### 150 - 200

| Miner   | Msg  | Sector | Gas       | AvgGas    |
| ------- | ---- | ------ | --------- | --------- |
| 145060  | 1    | 198    | 567156514 | 2864426.8 |
| 1169723 | 1    | 185    | 669644979 | 3619702.6 |
| 68556   | 1    | 196    | 446025320 | 2275639.4 |





、